{"version":3,"sources":["sd-keen-vis.es6.js"],"names":["Polymer","is","properties","counterValue","type","Number","value","notify","project","String","readKey","collection","targetProperty","groupBy","Array","filters","analysisType","timeframe","interval","yTitle","axisExtents","Object","chartYAxisConfig","readOnly","chartExtents","chartSeriesConfig","chartData","reflectToAttribute","observers","created","attached","_configureChartDefaults","_updateQuery","_initClient","console","log","client","Keen","projectId","_setChartYAxisConfig","_setChartExtents","ready","query","Query","event_collection","_runQuery","bind","run","err","res","result","_processResult","_setChartData","_buildSeriesConfig","_buildResultRanges","combined","metrics","_","forEach","ts_group","key","push","reduce","max","min","mean","map","n","x","parseInt","moment","end","format","isArray","preval","v","keys","pull","y_str","k","str","replace","seriesConfig","_setChartSeriesConfig","handleClick","event","detail","sender","increment"],"mappings":"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","file":"sd-keen-vis.js","sourcesContent":["(function() {\n  Polymer({\n\n    is: 'sd-keen-vis',\n\n    properties: {\n        /**\n        * This property keeps track of the number of clicks.\n        *\n        * @property counterValue\n        */\n        counterValue: {\n            type: Number,\n            value: 0,\n            notify: true\n        },\n        project: {\n            type: String\n        },\n        readKey: {\n            type: String\n        },\n        collection: {\n            type: String\n        },\n        targetProperty: {\n            type: String\n        },\n        groupBy: {\n            type: Array,\n            value: function() {\n                return []\n            }\n        },\n        filters: {\n            type: Array,\n            value: function() {\n                return []\n            }\n        },\n        analysisType: {\n            type: String\n        },\n        timeframe: {\n            type: String\n        },\n        interval: {\n            type: String\n        },\n        yTitle: {\n            type: String\n        },\n        // TODO get rid of this.\n        axisExtents: {\n            type: Object,\n            notify: true,\n            value: function() {\n                return {\"x\":[\"dynamic\",\"dynamic\"],\"y\":[\"dynamic\",\"dynamic\"]};\n            }\n        },\n        // Anything prefixed with chart = output.\n        chartYAxisConfig: {\n            type: Object,\n            notify: true,\n            readOnly: true,\n            value: function() {\n                return {}\n            }\n        },\n        chartExtents: {\n            type: Object,\n            notify: true,\n            readOnly: true,\n            value: function() {\n                return {\"x\":[\"dynamic\",\"dynamic\"],\"y\":[\"dynamic\",\"dynamic\"]};\n            }\n        },\n        chartSeriesConfig: {\n            type: Object,\n            notify: true,\n            readOnly: true,\n            value: function() {\n                return {};\n            }\n        },\n        chartData: {\n            type: Object,\n            notify: true,\n            reflectToAttribute: true,\n            value: function() {\n                return {}\n            },\n            readOnly: true\n        }\n    },\n    observers: [\n        '_initClient(project, key)',\n        '_updateQuery(collection, analysisType)'\n    ],\n    created: function() {\n    },\n    attached: function() {\n       this._configureChartDefaults();\n       this._updateQuery();\n    },\n    _initClient: function() {\n        console.log('initClient');\n        this.client = new Keen({\n            projectId: this.project,\n            readKey: this.readKey\n        });\n       this._updateQuery();\n    },\n    _configureChartDefaults: function() {\n        this._setChartYAxisConfig({\n            \"title\": this.yTitle || this.analysisType,\n            \"titleTruncation\": false\n        });\n        this._setChartExtents(this.axisExtents)\n        // TODO -- look at series config for ymax / ymin\n\n    },\n\n    _updateQuery: function() {\n        if (!this.client) {\n            this._initClient()\n        }\n        else {\n            Keen.ready(function() {\n                this.query = new Keen.Query(this.analysisType, {\n                    event_collection: this.collection,\n                    timeframe: this.timeframe,\n                    targetProperty: this.targetProperty,\n                    interval: this.interval,\n                    groupBy: this.groupBy,\n                    filters: this.filters\n                });\n                console.log(this.query);\n                this._runQuery();\n            }.bind(this));\n        }\n    },\n    _runQuery: function() {\n        if (this.client) {\n            this.client.run(this.query, function(err, res){\n                if (err) {\n                    // there was an error!\n                    console.log(err);\n                }\n                else {\n                    console.log(res);\n                    var result = this._processResult(res.result)\n                    this._setChartData(result);\n                    this._buildSeriesConfig();\n               }\n            }.bind(this));\n        }\n    },\n    _buildResultRanges: function(result) {\n        // TODO -- non grouped charts\n        var combined = {};\n        var metrics = {};\n        _.forEach(result, function(ts_group) {\n            _.forEach(ts_group, function(value, key) {\n                if (!combined[key]) {\n                    combined[key] = []\n                    combined[key].push(value)\n                }\n                else {\n                    combined[key].push(value)\n                }\n            })\n        });\n        metrics['grouped'] = _.reduce(combined, function(result, value, key) {\n            result[key] = {\n                'max': _.max(value),\n                'min': _.min(value),\n                'mean': _.mean(value)\n            }\n            if (result[key]['max'] == 0)\n                console.log(key);\n            return result;\n        }, {})\n\n        return metrics;\n\n    },\n    _processResult: function(result) {\n        result = _.map(result, function(n) {\n            // Intervals will automatically set x to timeseries.\n            var x = ''\n            if (this.interval)\n                var x = parseInt(moment(n.timeframe.end).format('x'))\n\n            // Check for grouping as value with groups comes back as array.\n            if (_.isArray(n.value)) {\n                var preval = _.map(n.value, function(v) {\n                    var keys = _.pull(_.keys(v), 'result')\n                    var y_str = _.reduce(keys, function(y_str, k) {\n                        var str = (y_str + v[k]).replace(/\\.|\\//g, '')\n                        console.log(str)\n                        return str\n                    }, '')\n                    v['y_str'] = y_str;\n                    return v;\n                });\n                var chartData = _.reduce(preval, function(result, value, key) {\n                    result[value.y_str] = value.result;\n                    return result;\n                }, {});\n                chartData['x'] = x\n                return chartData;\n            }\n            else\n                return {'x': x, 'y': n.value}\n\n        }.bind(this));\n\n        return result;\n    },\n    _buildSeriesConfig: function() {\n        console.log(this._buildResultRanges(this.chartData));\n        console.log(this.chartData);\n        const seriesConfig = _.reduce(this.chartData[0], function(result, value, key) {\n            result[key] = {\n                \"name\": key,\n                \"x\": \"x\",\n                \"y\": key\n            };\n            return result;\n        }, {});\n\n        console.log(seriesConfig);\n        this._setChartSeriesConfig(seriesConfig);\n\n    },\n\n\n    /**\n    * Handles click on the element defined in 'on-click' on the template.\n    *\n    * @method handleClick\n    */\n    handleClick: function(event, detail, sender) {\n      this.increment();\n    },\n\n    /**\n    * Increments the counter\n    *\n    * @method increment\n    */\n    increment: function() {\n      this.counterValue++;\n    }\n  });\n})();\n"]}